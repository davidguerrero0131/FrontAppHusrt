<app-biomedicausernavbar></app-biomedicausernavbar>
<div style="margin-top: 3%; margin-left: 5%; margin-right: 5%; background-color: white;">
</div>

<div style="margin-bottom: 2%;">
  <h1 style="text-align: center;">MANTENIMIENTOS DE EQUIPOS BIOMEDICOS</h1>
</div>

<div class="filtromes flex flex-column md:flex-row align-items-center gap-3" style="margin-bottom: 2%;">
  <h6 class="m-0">Seleccione un mes para visualizar:</h6>

  <p-datepicker [(ngModel)]="date" view="month" dateFormat="mm/yy" [readonlyInput]="true"
    inputStyleClass="w-full md:w-10rem"></p-datepicker>

  <button type="button" class="btn btn-dark" (click)="setDate()">
    Buscar
  </button>
</div>

<div>
  <h6 style="text-align: center;"> Mantenimientos del mes de {{obtenerNombreMes(mes)}} del año {{anio}}</h6>
</div>

<div class="btn-group botonesMenu" role="group" aria-label="Basic example">
  <button type="button" class="btn" [ngClass]="panelPreventivos ? 'btn-light' : 'btn-dark'" (click)="viewPreventivos()">
    Preventivos
  </button>

  <button type="button" class="btn" [ngClass]="panelMetas ? 'btn-light' : 'btn-dark'" (click)="viewMetas()">
    Metas
  </button>

  <button type="button" class="btn" [ngClass]="panelCorrectivos ? 'btn-light' : 'btn-dark'" (click)="viewCorrectivos()">
    Correctivos
  </button>
</div>

<div style="margin-top: 1%;">
  <div class="panelMantenimientos" *ngIf="panelPreventivos">

    <div class="card">
      <p-table #dt2 [value]="preventivos" dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50, 100]"
        [loading]="loading" [paginator]="true" [tableStyle]="{ 'min-width': '10rem' }"
        [globalFilterFields]="['equipo.nombres', 'usuario.nombres', 'equipo.serie', 'equipo.placa', 'servicio.nombres']">

        <ng-template #caption>
          <div class="flex">
            <p-iconfield iconPosition="left" class="ml-auto">
              <p-inputicon>
                <i class="pi pi-search"></i>
              </p-inputicon>
              <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Búsqueda General" />
            </p-iconfield>
          </div>
        </ng-template>

        <ng-template pTemplate="header">
          <tr>
            <th style="width:10%; align-items: center; text-align: center">Nombre</th>
            <th style="width:10%; align-items: center; text-align: center">Marca</th>
            <th style="width:10%; align-items: center; text-align: center">Modelo</th>
            <th style="width:10%; align-items: center; text-align: center">Serie</th>
            <th style="width:10%; align-items: center; text-align: center">Placa</th>
            <th style="width:15%; align-items: center; text-align: center">Servicio</th>
            <th style="width:15%; align-items: center; text-align: center">Ubicacion Especidica</th>
            <th style="width:15%; align-items: center; text-align: center">Asignado</th>
            <th style="width:10%; align-items: center; text-align: center">Estado</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-reporte>
          <tr>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                <a href="/biomedica/reportesequipo/{{reporte.equipo.id}}" role="button"
                  style="color: black;">{{reporte.equipo.nombres}}</a>
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.equipo.marca }}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.equipo.modelo }}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.equipo.serie }}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.equipo.placa }}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.servicio.nombres}}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.servicio.ubicacion}}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                -{{ reporte.usuario?.nombres}} {{reporte.usuario?.apellidos}}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <button type="button" class="btn btn-secondary" *ngIf="reporte.realizado && reporte.rutaPdf == null"
                (click)="viewModalReport(reporte.id)">REALIZADO</button>
              <button type="button" class="btn btn-success"
                *ngIf="reporte.realizado && reporte.rutaPdf != null" (click)="viewModalReport(reporte.id)">COMPLETADO</button>
              <button type="button" class="btn btn-warning" (click)="nuevoReporte(reporte.equipo.id, reporte.id)"
                *ngIf="!reporte.realizado && verificarVencimiento(reporte.mesProgramado, reporte['añoProgramado'])">PROGRAMADO</button>
              <button type="button" class="btn btn-danger" (click)="nuevoReporte(reporte.equipo.id, reporte.id)"
                *ngIf="!reporte.realizado && !verificarVencimiento(reporte.mesProgramado, reporte['añoProgramado'])">PENDIENTE</button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5">No hay Reportes.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <div class="panelMantenimientos" *ngIf="panelMetas">

    <div class="contenedor">
      <div class="izquierda">

        <button type="button" class="btn btn-dark btn-sm" style="width: 100%; margin-bottom: 2%;"
          (click)="panelRealizadosView()"> Realzados </button>
        <button type="button" class="btn btn-dark btn-sm" style="width: 100%;" (click)="panelPendientesView()">
          Pendientes </button>

      </div>
      <div class="derecha" *ngIf="panelRealizados">


        <div class="card">
          <p-table #dt2 [value]="preventivos" dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50, 100]"
            [loading]="loading" [paginator]="true" [tableStyle]="{ 'min-width': '10rem' }"
            [globalFilterFields]="['equipo.nombres', 'usuario.nombres', 'equipo.serie', 'equipo.placa', 'servicio.nombres']">

            <ng-template #caption>
              <div class="flex">
                <p-iconfield iconPosition="left" class="ml-auto">
                  <p-inputicon>
                    <i class="pi pi-search"></i>
                  </p-inputicon>
                  <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Búsqueda General" />
                </p-iconfield>
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <th style="width:10%; align-items: center; text-align: center">Nombre</th>
                <th style="width:10%; align-items: center; text-align: center">Marca</th>
                <th style="width:10%; align-items: center; text-align: center">Modelo</th>
                <th style="width:10%; align-items: center; text-align: center">Serie</th>
                <th style="width:10%; align-items: center; text-align: center">Placa</th>
                <th style="width:15%; align-items: center; text-align: center">Servicio</th>
                <th style="width:15%; align-items: center; text-align: center">Ubicacion Especidica</th>
                <th style="width:15%; align-items: center; text-align: center">Asignado</th>
                <th style="width:10%; align-items: center; text-align: center">Estado</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-reporte>
              <tr *ngIf="reporte.realizado == true">
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    <a href="/biomedica/reportesequipo/{{reporte.equipo.id}}" role="button"
                  style="color: black;">{{reporte.equipo.nombres}}</a>
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.equipo.marca }}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.equipo.modelo }}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.equipo.serie }}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.equipo.placa }}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.servicio.nombres}}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.servicio.ubicacion}}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    -{{ reporte.usuario?.nombres}} {{reporte.usuario?.apellidos}}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <button type="button" class="btn btn-secondary" (click)="viewModalReport(reporte.id)"
                    *ngIf="reporte.realizado && reporte.rutaPdf == null">REALIZADO</button>
                  <button type="button" class="btn btn-success"
                    *ngIf="reporte.realizado && reporte.rutaPdf != null">COMPLETADO</button>

                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="5">No hay Reportes.</td>
              </tr>
            </ng-template>
          </p-table>
        </div>


      </div>
      <div class="derecha" *ngIf="panelPendientes" style=" background-color: #d1e7dd;">

        <div class="card">
          <p-table #dt2 [value]="preventivos" dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50, 100]"
            [loading]="loading" [paginator]="true" [tableStyle]="{ 'min-width': '10rem' }"
            [globalFilterFields]="['equipo.nombres', 'usuario.nombres', 'equipo.serie', 'equipo.placa', 'servicio.nombres']">

            <ng-template #caption>
              <div class="flex">
                <p-iconfield iconPosition="left" class="ml-auto">
                  <p-inputicon>
                    <i class="pi pi-search"></i>
                  </p-inputicon>
                  <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Búsqueda General" />
                </p-iconfield>
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <th style="width:10%; align-items: center; text-align: center">Nombre</th>
                <th style="width:10%; align-items: center; text-align: center">Marca</th>
                <th style="width:10%; align-items: center; text-align: center">Modelo</th>
                <th style="width:10%; align-items: center; text-align: center">Serie</th>
                <th style="width:10%; align-items: center; text-align: center">Placa</th>
                <th style="width:15%; align-items: center; text-align: center">Servicio</th>
                <th style="width:15%; align-items: center; text-align: center">Ubicacion Especidica</th>
                <th style="width:15%; align-items: center; text-align: center">Asignado</th>
                <th style="width:10%; align-items: center; text-align: center">Realizado</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-reporte>
              <tr *ngIf="!reporte.realizado">
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    <a href="/biomedica/reportesequipo/{{reporte.equipo.id}}" role="button"
                  style="color: black;">{{reporte.equipo.nombres}}</a>
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.equipo.marca }}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.equipo.modelo }}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.equipo.serie }}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.equipo.placa }}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.servicio.nombres}}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    {{ reporte.servicio.ubicacion}}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <span class="ml-1 vertical-align-middle">
                    -{{ reporte.usuario?.nombres}} {{reporte.usuario?.apellidos}}
                  </span>
                </td>
                <td style="text-align: center; align-items: center; text-align: center">
                  <button type="button" class="btn btn-success" *ngIf="reporte.realizado">REALIZADO</button>
                  <button type="button" class="btn btn-danger" *ngIf="!reporte.realizado">PENDIENTE</button>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="5">No hay Reportes.</td>
              </tr>
            </ng-template>
          </p-table>
        </div>


      </div>
    </div>

  </div>


  <div class="panelMantenimientos" style="background-color: white;" *ngIf="panelCorrectivos">


    <div class="card">
      <p-table #dt2 [value]="correctivos" dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50, 100]"
        [loading]="loading" [paginator]="true" [tableStyle]="{ 'min-width': '10rem' }"
        [globalFilterFields]="['equipo.nombres', 'usuario.nombres', 'equipo.serie', 'equipo.placa', 'servicio.nombres']">


        <ng-template #caption>
          <div class="flex">
            <p-iconfield iconPosition="left" class="ml-auto">
              <p-inputicon>
                <i class="pi pi-search"></i>
              </p-inputicon>
              <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Búsqueda General" />
            </p-iconfield>
          </div>
        </ng-template>


        <ng-template pTemplate="header">
          <tr>
            <th style="width:10%; align-items: center; text-align: center">Nombre</th>
            <th style="width:10%; align-items: center; text-align: center">Marca</th>
            <th style="width:10%; align-items: center; text-align: center">Modelo</th>
            <th style="width:10%; align-items: center; text-align: center">Serie</th>
            <th style="width:10%; align-items: center; text-align: center">Placa</th>
            <th style="width:15%; align-items: center; text-align: center">Servicio</th>
            <th style="width:15%; align-items: center; text-align: center">Ubicacion Especidica</th>
            <th style="width:15%; align-items: center; text-align: center">Asignado</th>
            <th style="width:10%; align-items: center; text-align: center">Realizado</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-reporte>
          <tr>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                <a href="/biomedica/reportesequipo/{{reporte.equipo.id}}" role="button"
                  style="color: black;">{{reporte.equipo.nombres}}</a>
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.equipo.marca }}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.equipo.modelo }}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.equipo.serie }}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.equipo.placa }}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.servicio.nombres}}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle">
                {{ reporte.servicio.ubicacion}}
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <span class="ml-1 vertical-align-middle" *ngIf="reporte.usuario">
                -{{ reporte.usuario?.nombres}} {{reporte.usuario?.apellidos}}
              </span>
              <span class="ml-1 vertical-align-middle" *ngIf="!reporte.usuario">x
              </span>
            </td>
            <td style="text-align: center; align-items: center; text-align: center">
              <button type="button" class="btn btn-success">VER</button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5">No hay Reportes.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>


  </div>

</div>


<p-dialog header="Reporte N. {{ reportSelected?.id }}" [(visible)]="modalReport" [modal]="true" [responsive]="true"
  [style]="{ width: '90vw', maxWidth: '95%' }" [baseZIndex]="10000"
  [breakpoints]="{ '960px': '90vw', '640px': '95vw' }">
  <div class="p-fluid p-3">

    <!-- 1. Línea: Información del Equipo -->
    <div class="grid">
      <div class="col-12">
        <p-card header="Información del Equipo">
          <div class="p-text-sm grid">
            <div class="col-12 md:col-4">
              <p><strong>Nombre:</strong> {{ reportSelected?.equipo.nombres }}</p>
              <p><strong>Marca:</strong> {{ reportSelected?.equipo.marca }}</p>
              <p><strong>Modelo:</strong> {{ reportSelected?.equipo.modelo }}</p>
            </div>
            <div class="col-12 md:col-4">
              <p><strong>Serie:</strong> {{ reportSelected?.equipo.serie }}</p>
              <p><strong>Placa:</strong> {{ reportSelected?.equipo.placa }}</p>
              <p><strong>Activo:</strong> {{ reportSelected?.equipo.activo ? 'Sí' : 'No' }}</p>
            </div>
            <div class="col-12 md:col-4">
              <p><strong>Servicio:</strong> {{ reportSelected?.servicio.nombres }}</p>
              <p><strong>Ubicación:</strong> {{ reportSelected?.equipo.ubicacion }}</p>
              <p><strong>Ubicación Específica:</strong> {{ reportSelected?.equipo.ubicacionEspecifica }}</p>
            </div>
          </div>
        </p-card>
      </div>
    </div>

    <!-- 2. Línea: Detalles del Reporte -->
    <div class="grid">
      <div class="col-12">
        <p-card header="Detalle del Reporte">
          <div class="p-text-sm grid">
            <div class="col-12 md:col-4">
              <p><strong>Mes Programado:</strong> {{ reportSelected?.mesProgramado + 1 }}</p>
              <p><strong>Fecha Realizado:</strong> {{ reportSelected?.fechaRealizado }}</p>
              <p><strong>Hora Inicio:</strong> {{ reportSelected?.horaInicio }}</p>
              <p><strong>Fecha Fin:</strong> {{ reportSelected?.fechaFin }}</p>
              <p><strong>Trabajo Realizado:</strong> {{ reportSelected?.trabajoRealizado }}</p>
            </div>
            <div class="col-12 md:col-4">
              <p><strong>Hora Terminación:</strong> {{ reportSelected?.horaTerminacion }}</p>
              <p><strong>Hora Total:</strong> {{ reportSelected?.horaTotal }}</p>
              <p><strong>Tipo Mantenimiento:</strong> {{ reportSelected?.tipoMantenimiento }}</p>
              <p><strong>Tipo Falla:</strong> {{ reportSelected?.tipoFalla }}</p>
              <p><strong>Observaciones:</strong> {{ reportSelected?.observaciones }}</p>
            </div>
            <div class="col-12 md:col-4">
              <p><strong>Motivo:</strong> {{ reportSelected?.motivo }}</p>
              <p><strong>Calificación:</strong> {{ reportSelected?.calificacion }}</p>
              <p><strong>Mantenimiento Propio:</strong> {{ reportSelected?.mantenimientoPropio ? 'Sí' : 'No' }}</p>
              <p><strong>Realizado:</strong> {{ reportSelected?.realizado ? 'Sí' : 'No' }}</p>

            </div>
          </div>
        </p-card>
      </div>
    </div>

    <div>
      <p-card header="Rutina de Mantenimiento">
        <div class="p-text-sm grid">
          <div class="col-12">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Descripción</th>
                  <th>Cumplimiento</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of rutina">
                  <td>{{ item.protocolo.paso }}</td>
                  <td>{{ item.cumple ? 'Sí' : 'No' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </p-card>
    </div>

    <div style="margin-top: 1%;"></div>

    <div class="grid">
      <div class="col-12">
        <p-card header="Realizado Por:">
          <div class="p-text-sm grid">
            <div class="col-12 md:col-4">
              <p><strong>Nombre:</strong> {{ reportSelected?.usuario.nombres }} {{ reportSelected?.usuario.apellidos}}
              </p>
              <p><strong>Email:</strong> {{ reportSelected?.usuario.email }}</p>
              <p><strong>Registro Invima:</strong> {{ reportSelected?.usuario.registroInvima }}</p>
            </div>
            <div class="col-12 md:col-4">
              <button type="button" class="btn btn-dark" (click)="viewPdf(reportSelected?.rutaPdf)"
                *ngIf="reportSelected?.rutaPdf">Ver Reporte</button>
              <button type="button" class="btn btn-dark" (click)="viewPdf(reportSelected?.rutaPdf)"
                *ngIf="!reportSelected?.rutaPdf">Generar Formato</button>
            </div>
          </div>
        </p-card>
      </div>
    </div>
  </div>
</p-dialog>
