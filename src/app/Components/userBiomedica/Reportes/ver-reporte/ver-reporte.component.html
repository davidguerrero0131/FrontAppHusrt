<!-- Navbar -->


<!-- Contenedor principal -->
<!-- Contenedor principal -->
<div class="w-full md:w-11 m-auto mt-4 p-3 md:p-4 bg-white shadow-2 border-round">

  <!-- Títulos -->
  <div class="text-center mb-4">
    <h1 class="text-xl md:text-3xl font-bold">REPORTES DEL EQUIPO: {{ equipo?.nombres }}</h1>
    <h3 class="text-lg md:text-xl">{{ equipo?.marca }} {{equipo?.modelo}}</h3>
    <h6 class="text-sm md:text-base text-500">Serie {{ equipo?.serie }}</h6>
  </div>

  <!-- Botones Superiores -->
  <div class="flex justify-content-end mb-3">
    <p-button label="Ver Hoja de Vida" icon="pi pi-file" (onClick)="verHojaVida()"></p-button>
  </div>

  <p-tabView styleClass="w-full">
    <p-tabPanel header="Reportes de Mantenimiento">
      <p-table #dt2 [value]="reportes" dataKey="id" [paginator]="true" [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50, 100]" [loading]="loading"
        [globalFilterFields]="['tipoMantenimiento', 'tipoFalla', 'nombreRecibio']"
        [tableStyle]="{ 'min-width': '50rem' }" responsiveLayout="scroll">

        <!-- Filtro -->
        <ng-template #caption>
          <div class="flex justify-content-end">
            <p-iconfield iconPosition="left">
              <p-inputicon>
                <i class="pi pi-search"></i>
              </p-inputicon>
              <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Búsqueda General" />
            </p-iconfield>
          </div>
        </ng-template>

        <!-- Cabecera -->
        <ng-template pTemplate="header">
          <tr>
            <th style="width:5%">Numero</th>
            <th>Fecha</th>
            <th>Total Horas</th>
            <th>Tipo Mantenimiento</th>
            <th>Tipo Falla</th>
            <th>Realizo</th>
            <th>Recibio</th>
            <th>Observaciones</th>
            <th>Opciones</th>
          </tr>
        </ng-template>

        <!-- Cuerpo -->
        <ng-template pTemplate="body" let-reportes>
          <tr>
            <td>{{ reportes.id }}</td>
            <td>{{ reportes.fechaRealizado }}</td>
            <td>{{ reportes.horaTotal }}</td>
            <td>{{ reportes.tipoMantenimiento }}</td>
            <td>{{ reportes.tipoFalla }}</td>
            <td>{{ reportes.usuario?.nombres }} {{reportes.usuario?.apellidos}}</td>
            <td>{{ reportes.nombreRecibio }}</td>
            <td>{{ reportes.observaciones }}</td>
            <td style="text-align: center;" *ngIf=" reportes.tipoMantenimiento === 'Correctivo' ||  reportes.realizado">
              <button type="button" class="btn btn-dark btn-sm" style="margin: 2%;"
                (click)="viewModalReport(reportes)">Ver</button>
              <button type="button" class="btn btn-secondary btn-sm"
                (click)="editarReporte(reportes.id, reportes.equipoIdFk)"
                *ngIf="!reportes.rutaPdf && !isGuest() && reportes.usuarioIdFk === userId">Editar</button>
            </td>
            <td style="text-align: center;" *ngIf="!reportes.realizado && reportes.tipoMantenimiento !== 'Correctivo'">
              <button type="button" class="btn btn-warning btn-sm"
                (click)="viewModalReport(reportes)">Pendiente</button>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="10" class="text-center">No hay Registros de Reportes.</td>
          </tr>
        </ng-template>
      </p-table>
    </p-tabPanel>

    <p-tabPanel header="Actividades Metrológicas">
      <p-table [value]="metrologiaReportes" [paginator]="true" [rows]="10" [styleClass]="'p-datatable-sm'"
        responsiveLayout="scroll" [tableStyle]="{ 'min-width': '50rem' }">
        <ng-template pTemplate="header">
          <tr>
            <th>Fecha Realizado</th>
            <th>Tipo Actividad</th>
            <th>Empresa</th>
            <th>Resultado</th>
            <th>Error Máx.</th>
            <th>Observaciones</th>
            <th>Reporte</th>
            <th>Confirmación</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>{{ item.fechaRealizado | date:'dd/MM/yyyy' }}</td>
            <td>{{ item.tipoActividad }}</td>
            <td>{{ item.empresa }}</td>
            <td>
              <p-tag [value]="item.resultado" [severity]="item.resultado === 'Cumple' ? 'success' : 'danger'"></p-tag>
            </td>
            <td>{{ item.errorMaximoIdentificado }}</td>
            <td>{{ item.observaciones }}</td>
            <td>
              <button pButton icon="pi pi-file-pdf" class="p-button-rounded p-button-danger p-button-text"
                (click)="viewPdf(item.rutaReporte)" *ngIf="item.rutaReporte" pTooltip="Ver Reporte"></button>
            </td>
            <td>
              <button pButton icon="pi pi-file-pdf" class="p-button-rounded p-button-help p-button-text"
                (click)="viewPdf(item.confirmacionMetrologica)" *ngIf="item.confirmacionMetrologica"
                pTooltip="Ver Confirmación"></button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center">No hay actividades metrológicas registradas.</td>
          </tr>
        </ng-template>
      </p-table>
    </p-tabPanel>
  </p-tabView>
</div>




<div class="card flex justify-center">

  <p-dialog header="Reporte N. {{ reportSelected?.id }}" [(visible)]="modalReport" [modal]="true" [responsive]="true"
    styleClass="standard-modal modal-xl" [baseZIndex]="10000">
    <div class="p-fluid p-3">

      <!-- 1. Línea: Información del Equipo -->
      <div class="grid">
        <div class="col-12">
          <p-card header="Información del Equipo">
            <div class="p-text-sm grid">
              <div class="col-12 md:col-4">
                <p><strong>Nombre:</strong> {{ reportSelected?.equipo.nombres }}</p>
                <p><strong>Marca:</strong> {{ reportSelected?.equipo.marca }}</p>
                <p><strong>Modelo:</strong> {{ reportSelected?.equipo.modelo }}</p>
              </div>
              <div class="col-12 md:col-4">
                <p><strong>Serie:</strong> {{ reportSelected?.equipo.serie }}</p>
                <p><strong>Placa:</strong> {{ reportSelected?.equipo.placa }}</p>
                <p><strong>Activo:</strong> {{ reportSelected?.equipo.activo ? 'Sí' : 'No' }}</p>
              </div>
              <div class="col-12 md:col-4">
                <p><strong>Servicio:</strong> {{ reportSelected?.servicio.nombres }}</p>
                <p><strong>Ubicación:</strong> {{ reportSelected?.equipo.ubicacion }}</p>
                <p><strong>Ubicación Específica:</strong> {{ reportSelected?.equipo.ubicacionEspecifica }}</p>
              </div>
            </div>
          </p-card>
        </div>
      </div>

      <!-- 2. Línea: Detalles del Reporte -->
      <div class="grid">
        <div class="col-12">
          <p-card header="Detalle del Reporte">
            <div class="p-text-sm grid">
              <div class="col-12 md:col-4">
                <p><strong>Mes Programado:</strong> {{ reportSelected?.mesProgramado + 1 }}</p>
                <p><strong>Fecha Realizado:</strong> {{ reportSelected?.fechaRealizado }}</p>
                <p><strong>Hora Inicio:</strong> {{ reportSelected?.horaInicio }}</p>
                <p><strong>Fecha Fin:</strong> {{ reportSelected?.fechaFin }}</p>
                <p><strong>Trabajo Realizado:</strong> {{ reportSelected?.trabajoRealizado }}</p>
              </div>
              <div class="col-12 md:col-4">
                <p><strong>Hora Terminación:</strong> {{ reportSelected?.horaTerminacion }}</p>
                <p><strong>Hora Total:</strong> {{ reportSelected?.horaTotal }}</p>
                <p><strong>Tipo Mantenimiento:</strong> {{ reportSelected?.tipoMantenimiento }}</p>
                <p><strong>Tipo Falla:</strong> {{ reportSelected?.tipoFalla }}</p>
                <p><strong>Estado Operativo:</strong> {{ reportSelected?.estadoOperativo }}</p>
                <p><strong>Observaciones:</strong> {{ reportSelected?.observaciones }}</p>
              </div>
              <div class="col-12 md:col-4">
                <p><strong>Motivo:</strong> {{ reportSelected?.motivo }}</p>
                <p><strong>Calificación:</strong> {{ reportSelected?.calificacion }}</p>
                <p><strong>Mantenimiento Propio:</strong> {{ reportSelected?.mantenimientoPropio ? 'Sí' : 'No' }}</p>
                <p><strong>Realizado:</strong> {{ reportSelected?.realizado ? 'Sí' : 'No' }}</p>

              </div>
            </div>
          </p-card>
        </div>
      </div>

      <!-- Equipo Patrón Section -->
      <div class="grid" *ngIf="reportSelected?.equipoPatronIdFk">
        <div class="col-12">
          <p-card header="Información del Equipo Patrón">
            <div class="p-text-sm grid">
              <div class="col-12 md:col-4">
                <p><strong>Nombre:</strong> {{ reportSelected?.equipoPatron?.nombres }}</p>
                <p><strong>Marca:</strong> {{ reportSelected?.equipoPatron?.marca }}</p>
              </div>
              <div class="col-12 md:col-4">
                <p><strong>Modelo:</strong> {{ reportSelected?.equipoPatron?.modelo }}</p>
                <p><strong>Serie:</strong> {{ reportSelected?.equipoPatron?.serie }}</p>
              </div>
              <div class="col-12 md:col-4">
                <p><strong>Placa/Código:</strong> {{ reportSelected?.equipoPatron?.placa }}</p>
              </div>
            </div>
          </p-card>
        </div>
      </div>

      <div class="grid" *ngIf="reportSelected?.cumplimientoCondicionesIniciales?.length > 0">
        <div class="col-12">
          <p-card header="Condiciones Iniciales">
            <div class="p-text-sm grid">
              <div class="col-12">
                <table class="table table-striped table-bordered">
                  <thead>
                    <tr>
                      <th>Condición</th>
                      <th>Cumplimiento</th>
                      <th>Observaciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of reportSelected.cumplimientoCondicionesIniciales">
                      <td>{{ item.condicionInicial?.descripcion }}</td>
                      <td>{{ item.cumple === 'CUMPLE' ? 'Cumple' : (item.cumple === 'NO_CUMPLE' ? 'No Cumple' :
                        (item.cumple === 'NO_APLICA' ? 'No Aplica' : 'No')) }}</td>
                      <td>{{ item.observacion }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </p-card>
        </div>
      </div>

      <div class="grid" *ngIf="reportSelected?.valoresMediciones?.length > 0">
        <div class="col-12">
          <p-card header="Mediciones Específicas">
            <div class="p-text-sm grid">
              <div class="col-12">
                <table class="table table-striped table-bordered">
                  <thead>
                    <tr>
                      <th>Medición</th>
                      <th>Estándar</th>
                      <th>Valor</th>
                      <th>Unidad Reg.</th>
                      <th>Criterio Aceptación</th>
                      <th>Conforme</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let val of reportSelected.valoresMediciones">
                      <td>{{ val.medicion?.nombre }} ({{ val.medicion?.unidad }})</td>
                      <td>{{ val.medicion?.valorEstandar || 'N/A' }}</td>
                      <td>{{ val.valor }}</td>
                      <td>{{ val.unidadRegistrada || val.medicion?.unidad }}</td>
                      <td>{{ val.medicion?.criterioAceptacion || 'N/A' }}</td>
                      <td>{{ val.conforme ? 'Sí' : 'No' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </p-card>
        </div>
      </div>

      <div>
        <p-card header="Rutina de Mantenimiento">
          <div class="p-text-sm grid">
            <div class="col-12">
              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Descripción</th>
                    <th>Cumplimiento</th>
                    <th>Observaciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of rutina">
                    <td>{{ item.protocolo.paso }}</td>
                    <td>{{ item.cumple === 'CUMPLE' ? 'Cumple' : (item.cumple === 'NO_CUMPLE' ? 'No Cumple' :
                      (item.cumple === 'NO_APLICA' ? 'No Aplica' : 'No')) }}</td>
                    <td>{{ item.observaciones }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </p-card>
      </div>

      <div class="grid" *ngIf="reportSelected?.repuestos?.length > 0">
        <div class="col-12">
          <p-card header="Insumos / Repuestos Utilizados">
            <div class="p-text-sm grid">
              <div class="col-12">
                <table class="table table-striped table-bordered">
                  <thead>
                    <tr>
                      <th>Nombre Insumo</th>
                      <th>Cantidad</th>
                      <th>Comprobante</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let rep of reportSelected.repuestos">
                      <td>{{ rep.nombreInsumo }}</td>
                      <td>{{ rep.cantidad }}</td>
                      <td>{{ rep.comprobanteEgreso || 'N/A' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </p-card>
        </div>
      </div>

      <div style="margin-top: 1%;"></div>

      <div class="grid">
        <div class="col-12">
          <p-card header="Realizado Por:">
            <div class="p-text-sm grid">
              <div class="col-12 md:col-4">
                <p><strong>Nombre:</strong> {{ reportSelected?.usuario.nombres }} {{ reportSelected?.usuario.apellidos}}
                </p>
                <p><strong>Email:</strong> {{ reportSelected?.usuario.email }}</p>
                <p><strong>Registro Invima:</strong> {{ reportSelected?.usuario.registroInvima }}</p>

              </div>
              <div class="col-12 md:col-4">
                <button type="button" class="btn btn-dark" (click)="viewPdf(reportSelected?.rutaPdf)"
                  *ngIf="reportSelected?.rutaPdf">Ver Reporte</button>
                <div *ngIf="!reportSelected?.rutaPdf" class="flex flex-column gap-2">
                  <div *ngIf="!isGuest()">
                    <button type="button" class="btn btn-dark mb-2" (click)="descargarFormato()">Generar
                      Formato</button>
                    <hr>
                    <label class="font-bold">Cargar Reporte Firmado (PDF):</label>
                    <input type="file" (change)="onFileSelected($event)" accept=".pdf" class="form-control mb-2">
                    <button type="button" class="btn btn-primary" [disabled]="!selectedFile" (click)="subirPdf()">
                      <i class="pi pi-upload mr-1"></i> Guardar PDF
                    </button>
                  </div>
                  <div *ngIf="isGuest()" class="text-center p-3 surface-100 border-round">
                    <p class="text-500 italic m-0">Reporte pendiente de carga por personal autorizado.</p>
                  </div>
                </div>
              </div>

            </div>
          </p-card>
        </div>
      </div>
    </div>
  </p-dialog>


</div>