<div style="margin-top: 3%; margin-left: 5%; margin-right: 5%; background-color: white;">
</div>

<div style="margin-bottom: 2%;">
  <h1 style="text-align: center;">MANTENIMIENTOS DE EQUIPOS INDUSTRIALES</h1>
  <div class="text-center mt-3">
    <button class="btn btn-outline-secondary" (click)="regresar()">
      <i class="pi pi-arrow-left"></i> Volver al panel
    </button>
  </div>
</div>

<div class="filtromes flex flex-wrap align-items-center justify-content-center gap-3" style="margin-bottom: 2%;">

  <div class="flex align-items-center gap-2">
    <label class="font-bold">Año:</label>
    <input pInputText type="number" [(ngModel)]="anio" placeholder="YYYY" class="w-8rem" />
  </div>

  <div class="flex align-items-center gap-2">
    <label class="font-bold">Inicio:</label>
    <p-dropdown [options]="meses" [(ngModel)]="mesInicio" optionLabel="label" optionValue="value"
      placeholder="Mes Inicio" [style]="{'width':'10rem'}"></p-dropdown>
  </div>

  <div class="flex align-items-center gap-2">
    <label class="font-bold">Fin:</label>
    <p-dropdown [options]="meses" [(ngModel)]="mesFin" optionLabel="label" optionValue="value" placeholder="Mes Fin"
      [style]="{'width':'10rem'}"></p-dropdown>
  </div>

  <button type="button" class="btn btn-dark" (click)="setDate()">
    Buscar
  </button>
</div>

<div>
  <h6 style="text-align: center;" *ngIf="mesInicio === mesFin">
    Mantenimientos del mes de {{obtenerNombreMes(mesInicio)}} del año {{anio}}
  </h6>
  <h6 style="text-align: center;" *ngIf="mesInicio !== mesFin">
    Mantenimientos de {{obtenerNombreMes(mesInicio)}} a {{obtenerNombreMes(mesFin)}} del año {{anio}}
  </h6>
</div>

<div class="btn-group botonesMenu" role="group" aria-label="Basic example">
  <button type="button" class="btn" [ngClass]="panelPreventivos ? 'btn-warning' : 'btn-dark'"
    (click)="viewPreventivos()">
    Preventivos
  </button>

  <button type="button" class="btn" [ngClass]="panelMetas ? 'btn-warning' : 'btn-dark'" (click)="viewMetas()">
    Metas
  </button>

  <button type="button" class="btn" [ngClass]="panelCorrectivos ? 'btn-warning' : 'btn-dark'"
    (click)="viewCorrectivos()">
    Correctivos
  </button>
</div>

<div style="margin-top: 1%;">
  <div class="panelMantenimientos" *ngIf="panelPreventivos">

    <div class="card">
      <p-table #dt2 [value]="preventivos" dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50, 100]"
        [loading]="loading" [paginator]="true" [tableStyle]="{ 'min-width': '10rem' }"
        [globalFilterFields]="['equipo.nombres', 'equipo.marca', 'equipo.serie', 'equipo.placa', 'equipo.servicioInd.nombres']">

        <ng-template #caption>
          <div class="flex">
            <p-iconfield iconPosition="left" class="ml-auto">
              <p-inputicon>
                <i class="pi pi-search"></i>
              </p-inputicon>
              <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Búsqueda General" />
            </p-iconfield>
          </div>
        </ng-template>

        <ng-template pTemplate="header">
          <tr>
            <th style="width:10%; align-items: center; text-align: center">Nombre</th>
            <th style="width:10%; align-items: center; text-align: center">Marca</th>
            <th style="width:10%; align-items: center; text-align: center">Modelo</th>
            <th style="width:10%; align-items: center; text-align: center">Serie</th>
            <th style="width:10%; align-items: center; text-align: center">Placa</th>
            <th style="width:15%; align-items: center; text-align: center">Servicio</th>
            <th style="width:15%; align-items: center; text-align: center">Sede</th>
            <th style="width:15%; align-items: center; text-align: center">Ubicacion Específica</th>
            <th style="width:10%; align-items: center; text-align: center">Mes</th>
            <th style="width:10%; align-items: center; text-align: center">Estado</th>
            <th style="width:10%; align-items: center; text-align: center" *ngIf="userRole !== 'INDUSTRIALESUSER'">
              Opciones</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-plan>
          <tr>
            <td style="text-align: center; align-items: center;">
              {{plan.equipo?.nombres}}
            </td>
            <td style="text-align: center; align-items: center;">
              {{ plan.equipo?.marca }}
            </td>
            <td style="text-align: center; align-items: center;">
              {{ plan.equipo?.modelo }}
            </td>
            <td style="text-align: center; align-items: center;">
              {{ plan.equipo?.serie }}
            </td>
            <td style="text-align: center; align-items: center;">
              {{ plan.equipo?.placa }}
            </td>
            <td style="text-align: center; align-items: center;">
              {{ plan.equipo?.servicioInd?.nombres}}
            </td>
            <td style="text-align: center; align-items: center;">
              {{ plan.equipo?.sedeInd?.nombres || 'Sin Sede' }}
            </td>
            <td style="text-align: center; align-items: center;">
              {{ plan.equipo?.ubicacionEspecifica || 'N/A'}}
            </td>
            <td style="text-align: center; align-items: center;">
              {{ obtenerNombreMes(plan.mes) }}
            </td>
            <td style="text-align: center; align-items: center;">
              <p-tag [severity]="getEstadoSeverity(plan.estado)" [value]="getEstadoLabel(plan.estado)"
                [style]="{'cursor': (plan.estado === 1 || plan.estado === 2 || plan.estado === 3 || plan.estado === 4) && (userRole === 'INDUSTRIALESADMIN' || userRole === 'INDUSTRIALESTECNICO') ? 'pointer' : 'default'}"
                (click)="(plan.estado === 1 || plan.estado === 2 || plan.estado === 3 || plan.estado === 4) && (userRole === 'INDUSTRIALESADMIN' || userRole === 'INDUSTRIALESTECNICO') ? irAReporte(plan) : null">
              </p-tag>
            </td>
            <td style="text-align: center; align-items: center;" *ngIf="userRole !== 'INDUSTRIALESUSER'">
              <button type="button" class="btn btn-info ml-1" (click)="verDetalle(plan.id)" pTooltip="Ver Detalle">
                <i class="pi pi-eye"></i>
              </button>
              <button type="button" class="btn btn-warning ml-1" (click)="editarPlan(plan.id)" pTooltip="Editar"
                *ngIf="userRole === 'INDUSTRIALESADMIN'">
                <i class="pi pi-pencil"></i>
              </button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="11">No hay planes registrados.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <div class="panelMantenimientos" *ngIf="panelMetas">
    <h4 class="text-center">Funcionalidad Metas en Construcción</h4>
  </div>

  <div class="panelMantenimientos" *ngIf="panelCorrectivos">
    <h4 class="text-center">Funcionalidad Correctivos en Construcción</h4>
  </div>

</div>

<p-dialog header="Resumen del Reporte" [(visible)]="displayReporteDialog" [modal]="true" [style]="{width: '50vw'}"
  [draggable]="false" [resizable]="false">
  <div *ngIf="reporteSeleccionado" class="p-fluid">
    <div class="field grid">
      <label class="col-12 md:col-4 font-bold">Fecha Realizado:</label>
      <div class="col-12 md:col-8">{{ reporteSeleccionado.fechaRealizado | date:'dd/MM/yyyy' }}</div>
    </div>
    <div class="field grid">
      <label class="col-12 md:col-4 font-bold">Tipo Mantenimiento:</label>
      <div class="col-12 md:col-8">{{ reporteSeleccionado.tipoMantenimiento }}</div>
    </div>
    <div class="field grid">
      <label class="col-12 md:col-4 font-bold">Realizado Por:</label>
      <div class="col-12 md:col-8">{{ reporteSeleccionado.usuario?.nombre || 'N/A' }}</div>
    </div>
    <div class="field grid">
      <label class="col-12 md:col-4 font-bold">Trabajo Realizado:</label>
      <div class="col-12 md:col-8">{{ reporteSeleccionado.trabajoRealizado }}</div>
    </div>
    <div class="field grid">
      <label class="col-12 md:col-4 font-bold">Observaciones:</label>
      <div class="col-12 md:col-8">{{ reporteSeleccionado.observaciones || 'Ninguna' }}</div>
    </div>
    <div class="field grid">
      <label class="col-12 md:col-4 font-bold">Recibido Por:</label>
      <div class="col-12 md:col-8">{{ reporteSeleccionado.nombreRecibio }}</div>
    </div>

    <div class="field grid" *ngIf="reporteSeleccionado.rutaImagen">
      <label class="col-12 md:col-4 font-bold">Imágenes Adjuntas:</label>
      <div class="col-12 md:col-8">
        <div *ngFor="let img of getImagenesReporte(reporteSeleccionado.rutaImagen)" class="mb-2">
          <img [src]="API_URL + '/api/industriales/reportes/imagen/' + img" alt="Imagen del Reporte"
            style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 10px;">
        </div>
      </div>
    </div>

    <div *ngIf="rutina && rutina.length > 0">
      <div class="field grid">
        <div class="col-12 font-bold">Rutina de Mantenimiento:</div>
        <div class="col-12">
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Descripción</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of rutina">
                <td>{{ item.protocoloPreventivo?.paso || 'Paso ' + item.protocoloPreventivoIdFk }}</td>
                <td>
                  <span [ngClass]="{
                        'text-green-600 font-bold': item.cumple === 'Realizado',
                        'text-red-600 font-bold': item.cumple === 'No Realizado',
                        'text-blue-600 font-bold': item.cumple === 'No Aplica'
                    }">{{ item.cumple }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button icon="pi pi-check" (click)="displayReporteDialog=false" label="Cerrar"
      styleClass="p-button-text"></p-button>
  </ng-template>
</p-dialog>