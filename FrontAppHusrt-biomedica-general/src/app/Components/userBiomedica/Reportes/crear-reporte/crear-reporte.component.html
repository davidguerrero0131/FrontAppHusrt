<div class="title-container">
  <h2><strong> REPORTE DE MANTENIMINETO {{convertirMayusculas(tipoMantenimiento)}}</strong></h2>
</div>

<div class="title-container">
  <h4><strong> DATOS DEL EQUIPO </strong></h4>
</div>

<div class="custom-grid" style="width: 94%; margin-left: 3%; margin-right: 3%;">

  <div class="form-item">
    <label>Nombre Equipo</label>
    <input pInputText type="nombreEquipo" placeholder="{{equipo?.nombres}}" disabled />
  </div>

  <div class="form-item">
    <label>Marca</label>
    <input pInputText type="nombreEquipo" placeholder="{{equipo?.marca}}" disabled />
  </div>

  <div class="form-item">
    <label>Modelo</label>
    <input pInputText type="nombreEquipo" placeholder="{{equipo?.modelo}}" disabled />
  </div>

  <div class="form-item">
    <label>Serie</label>
    <input pInputText type="nombreEquipo" placeholder="{{equipo?.serie}}" disabled />
  </div>

  <div class="form-item">
    <label>Servicio</label>
    <input pInputText type="nombreEquipo" placeholder="{{equipo?.servicios.nombres}}" disabled />
  </div>

  <div class="form-item">
    <label>Ubicación</label>
    <input pInputText type="nombreEquipo" placeholder="{{equipo?.ubicacion}}" disabled />
  </div>

  <div class="form-item">
    <label>Ubicación especifica</label>
    <input pInputText type="nombreEquipo" placeholder="{{equipo?.ubicacionEspecifica}}" disabled />
  </div>
</div>

<div class="title-container">
  <h4><strong> DATOS DEL REPORTE </strong></h4>
</div>

<div class="form-container">
  <p-card>
    <form [formGroup]="reporteForm" (ngSubmit)="onSubmit()">
      <div class="custom-grid">

        <div class="form-item">
          <label>Fecha Inicio</label>
          <p-datePicker formControlName="fechaRealizado" inputId="fechaRealizado" showIcon dateFormat="yy-mm-dd" />
        </div>

        <div class="form-item">
          <label>Hora Inicio</label>
          <input pInputText type="time" formControlName="horaInicio" />
        </div>

        <div class="form-item">
          <label>Fecha Fin</label>
          <p-datePicker formControlName="fechaFin" inputId="fechaFin" showIcon dateFormat="yy-mm-dd" />
        </div>

        <div class="form-item">
          <label>Hora Terminación</label>
          <input pInputText type="time" formControlName="horaTerminacion" />
        </div>

        <div class="form-item">
          <label>Hora Total</label>
          <input pInputText type="text" formControlName="horaTotal" readonly />
        </div>

        <div class="form-item">
          <label>Tipo de Mantenimiento</label>
          <p-select [options]="tiposMantenimiento" formControlName="tipoMantenimiento"
            placeholder="tipoMantenimiento"></p-select>
        </div>

        <div class="form-item">
          <label>Tipo de Falla</label>
          <p-select [options]="tiposFalla" formControlName="tipoFalla" placeholder="Seleccione"></p-select>
        </div>

        <div class="form-item">
          <label>Estado Operativo</label>
          <p-select [options]="estadosOperativos" formControlName="estadoOperativo" placeholder="Seleccione"></p-select>
        </div>



        <div class="form-item">
          <label>Calificación (1-5)</label>
          <input pInputText type="number" formControlName="calificacion" min="1" max="5" />
        </div>

        <div class="form-item">
          <label>Nombre Realizo</label>
          <input pInputText placeholder="{{nombreUsuario?.nombreCompleto}}" type="nombreRealizo" disabled />
        </div>

        <div class="form-item">
          <label>Identificacion Realizo</label>
          <input pInputText placeholder="{{nombreUsuario?.numeroId}}" type="nombreRealizo" disabled />
        </div>

        <div class="form-item">
          <label>Nombre Recibió</label>
          <input pInputText formControlName="nombreRecibio" />
        </div>

        <div class="form-item">
          <label>Cédula Recibió</label>
          <input pInputText formControlName="cedulaRecibio" />
        </div>

      </div>
      <div style="margin-top: 3%;"></div>
      <div class="custom-grid">
        <div class="form-item">
          <label>Motivo</label>
          <textarea pInputTextarea rows="3" formControlName="motivo"></textarea>
        </div>
        <div class="form-item">
          <label>Trabajo Realizado</label>
          <textarea pInputTextarea rows="3" formControlName="trabajoRealizado"></textarea>
        </div>
        <div class="form-item">
          <label>Observaciones</label>
          <textarea pInputTextarea rows="3" formControlName="observaciones"></textarea>
        </div>
      </div>

      <div style="margin-top: 3%;"></div>

      <!-- Equipo Patron Section -->
      <div class="title-container"
        *ngIf="reporteForm.get('tipoMantenimiento')?.value === 'Correctivo' || reporteForm.get('tipoMantenimiento')?.value === 'Preventivo'">
        <h4><strong> EQUIPO PATRON </strong></h4>
        <H6>Seleccione el equipo patron utilizado (Opcional)</H6>
      </div>

      <div class="custom-grid"
        *ngIf="reporteForm.get('tipoMantenimiento')?.value === 'Correctivo' || reporteForm.get('tipoMantenimiento')?.value === 'Preventivo'">
        <div class="form-item">
          <label>Equipo Patron</label>
          <p-dropdown [options]="equiposPatron" formControlName="equipoPatronIdFk" optionLabel="nombres"
            optionValue="id" placeholder="Seleccione Equipo (Nombre)" [filter]="true" filterBy="nombres"
            [showClear]="true" appendTo="body" (onChange)="onSelectPatron()"></p-dropdown>
        </div>

        <div class="form-item">
          <label>Marca</label>
          <input pInputText [value]="selectedPatron?.marca || ''" readonly placeholder="Marca" />
        </div>

        <div class="form-item">
          <label>Modelo</label>
          <input pInputText [value]="selectedPatron?.modelo || ''" readonly placeholder="Modelo" />
        </div>

        <div class="form-item">
          <label>Serie</label>
          <input pInputText [value]="selectedPatron?.serie || ''" readonly placeholder="Serie" />
        </div>

        <div class="form-item">
          <label>Placa Inventario</label>
          <input pInputText [value]="selectedPatron?.placa || ''" readonly placeholder="Placa" />
        </div>
      </div>

      <!-- Specific Measurements Section -->
      <div class="title-container"
        *ngIf="reporteForm.get('tipoMantenimiento')?.value === 'Preventivo' && valoresMedicionesFormArray.controls.length > 0">
        <h4><strong> MEDICIONES ESPECÍFICAS </strong></h4>
        <H6>Ingrese los valores medidos para este equipo</H6>
      </div>

      <div
        *ngIf="reporteForm.get('tipoMantenimiento')?.value === 'Preventivo' && valoresMedicionesFormArray.controls.length > 0">
        <div formArrayName="valoresMediciones" class="w-full px-3">
          <p-table [value]="valoresMedicionesFormArray.controls" responsiveLayout="scroll" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th style="width: 20%">Medición</th>
                <th style="width: 15%">Estándar</th>
                <th style="width: 15%">Valor</th>
                <th style="width: 15%">Unidad Reg.</th>
                <th style="width: 25%">Criterio Aceptación</th>
                <th style="width: 10%" class="text-center">Conforme</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-medicion let-i="rowIndex">
              <tr [formGroupName]="i">
                <td>
                  <span class="font-bold block">{{ medicion.get('nombre')?.value }}</span>
                  <span class="text-sm text-500">{{ medicion.get('unidad')?.value }}</span>
                </td>
                <td>{{ medicion.get('valorEstandar')?.value || 'N/A' }}</td>
                <td><input pInputText formControlName="valor" class="w-full" /></td>
                <td><input pInputText formControlName="unidadRegistrada" class="w-full" /></td>
                <td>{{ medicion.get('criterioAceptacion')?.value }}</td>
                <td class="text-center">
                  <p-checkbox formControlName="conforme" [binary]="true"></p-checkbox>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>

      <!-- Initial Conditions Section (Global) -->
      <div class="title-container"
        *ngIf="reporteForm.get('tipoMantenimiento')?.value === 'Preventivo' && condicionesInicialesFormArray.controls.length > 0">
        <h4><strong> CONDICIONES INICIALES </strong></h4>
        <H6>Verifique las condiciones iniciales del equipo</H6>
      </div>

      <div
        *ngIf="reporteForm.get('tipoMantenimiento')?.value === 'Preventivo' && condicionesInicialesFormArray.controls.length > 0"
        class="mb-5">
        <div formArrayName="condicionesIniciales" class="w-full px-3">
          <p-table [value]="condicionesInicialesFormArray.controls" responsiveLayout="scroll"
            styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th style="width: 20%" class="text-center">Cumple</th>
                <th style="width: 50%">Condición</th>
                <th style="width: 30%">Observaciones</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-grupo let-i="rowIndex">
              <tr [formGroupName]="i">
                <td class="text-center">
                  <p-dropdown [options]="opcionesCumplimiento" formControlName="cumple" optionLabel="label"
                    optionValue="value" appendTo="body" [style]="{'width':'150px'}"></p-dropdown>
                </td>
                <td>
                  {{ grupo.get('descripcion')?.value }}
                </td>
                <td>
                  <input pInputText formControlName="observacion" class="w-full" placeholder="Ingrese observación..." />
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>

      <div class="title-container" *ngIf="reporteForm.get('tipoMantenimiento')?.value === 'Preventivo'">
        <h4><strong> PROTOCOLO PREVENTIVO </strong></h4>
        <H6>Seleccione los pasos realizados en el mantenimiento</H6>
      </div>
      <div *ngIf="reporteForm.get('tipoMantenimiento')?.value === 'Preventivo'">
        <div formArrayName="cumplimientoProtocolo" class="w-full px-3">
          <p-table [value]="cumplimientoProtocoloFormArray.controls" responsiveLayout="scroll"
            styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th style="width: 20%" class="text-center">Cumple</th>
                <th style="width: 50%">Paso</th>
                <th style="width: 40%">Observaciones</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-grupo let-i="rowIndex">
              <tr [formGroupName]="i">
                <td class="text-center">
                  <p-dropdown [options]="opcionesCumplimiento" formControlName="cumple" optionLabel="label"
                    optionValue="value" appendTo="body" [style]="{'width':'150px'}"></p-dropdown>
                </td>
                <td>
                  <label [for]="'chk-' + i" class="cursor-pointer">{{ grupo.get('paso')?.value }}</label>
                </td>
                <td>
                  <input pInputText formControlName="observaciones" class="w-full"
                    placeholder="Ingrese observación..." />
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>

      <div class="title-container" *ngIf="repuestosFormArray">
        <h4><strong> INSUMOS / REPUESTOS </strong></h4>
        <H6>Registre los repuestos o insumos utilizados en el mantenimiento</H6>
      </div>
      <div>
        <div formArrayName="repuestos" class="w-full px-3">
          <p-table [value]="repuestosFormArray.controls" responsiveLayout="scroll" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th style="width: 30%">Nombre Insumo</th>
                <th style="width: 20%">Cantidad</th>
                <th style="width: 30%">Comprobante Egreso</th>
                <th style="width: 10%">Acción</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-repuesto let-i="rowIndex">
              <tr [formGroupName]="i">
                <td><input pInputText formControlName="nombreInsumo" class="w-full" placeholder="Nombre" /></td>
                <td><input pInputText formControlName="cantidad" class="w-full" placeholder="Cant." /></td>
                <td><input pInputText formControlName="comprobanteEgreso" class="w-full"
                    placeholder="Ref. / Comprobante" /></td>
                <td class="text-center">
                  <button pButton type="button" icon="pi pi-trash"
                    class="p-button-danger p-button-rounded p-button-text" (click)="eliminarRepuesto(i)"></button>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="footer">
              <tr>
                <td colspan="4" class="text-right">
                  <button pButton label="Agregar Insumo" icon="pi pi-plus" class="p-button-sm p-button-outlined"
                    (click)="agregarRepuesto()" type="button"></button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>


      <div style="margin-top: 3%;"></div>

      <div class="custom-grid">
        <button type="submit" class="btn btn-dark">Guardar</button>
        <button type="button" class="btn btn-secondary" (click)="goBack()">Cancelar</button>
        <div></div>
        <div></div>
      </div>
    </form>
  </p-card>
</div>